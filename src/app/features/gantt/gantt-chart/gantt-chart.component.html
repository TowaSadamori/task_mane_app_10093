<div class="gantt-container">
    <div class="timeline-header">
        <div class="timeline-row timeline-year">
            <div *ngFor="let yearItem of timelineYears" 
                 class="timeline-cell year-cell" 
                 [style.minWidth.px]="yearItem.colspan * 50" [style.flexBasis.px]="yearItem.colspan * 50"> 
                 {{ yearItem.year }}年
            </div>
        </div>
        <div class="timeline-row timeline-month">
            <ng-container *ngFor="let yearItem of timelineYears">
                <div *ngFor="let monthItem of yearItem.months" 
                     class="timeline-cell month-cell"
                     [style.minWidth.px]="monthItem.colspan * 50"
                     [style.flexBasis.px]="monthItem.colspan * 50">
                     {{ monthItem.monthName }}
                </div>
            </ng-container>
        </div>
        <div class="timeline-row timeline-days">
            <div *ngFor="let dayItem of allDaysInTimeline" 
                 class="timeline-cell day-cell"
                 [class.weekend]="dayItem.isWeekend"> {{ dayItem.dayNumber }}
            </div>
        </div>


    </div>

    <div class="main-gantt-area">
        <div class="task-list-area">
            <div class="action-buttons-container" style="margin-bottom: 10px; text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
                <button mat-raised-button color="primary" (click)="openAddTaskDialog()">
                    <mat-icon>add_circle_outline</mat-icon> タスク追加
                </button>
            </div>
            <div class="task-list-header">
                <div class="task-list-cell header-cell" style="width: 50px;">番号</div>
                <div class="task-list-cell header-cell" style="width: 150px">タスク名</div>
                <div class="task-list-cell header-cell" style="width: 100px">担当者</div>
                <div class="task-list-cell header-cell" style="width: 80px">状況</div>
                <div class="task-list-cell header-cell" style="width: 70px;">進捗率</div>
                <div class="task-list-cell header-cell" style="width: 100px">予定開始日</div>
                <div class="task-list-cell header-cell" style="width: 100px">予定終了日</div>
                <div class="task-list-cell header-cell" style="width: 100px;">実績開始日</div>
                <div class="task-list-cell header-cell" style="width: 100px;">実績終了日</div>
                <div class="task-list-cell header-cell" style="width: 100px;">操作</div>
            </div>

            
            <div *ngFor="let taskItem of ganttTasks; let i = index; trackBy: trackByTaskId"
                 class="task-list-row"
                 [id]="'task-row-' + taskItem.id!" (click)="selectTask(taskItem)" tabindex="0"
                 (keydown.enter)="selectTask(taskItem)"
                 (keydown.space)="selectTask(taskItem)"
                 [ngClass]="{'selected-task': taskItem.id === selectedTask?.id}">
                 <div class="task-list-cell" style="width: 50px;">{{ i + 1 }}</div>
                 <div class="task-list-cell"
                     style="width: 150px; cursor: pointer; text-decoration: underline; color: blue;"
                     [style.paddingLeft.px]="taskItem.level ? taskItem.level * 20 : 0"
                     (click)="navigateToTaskDetail(taskItem.id!); $event.stopPropagation()"
                     (keydown.enter)="navigateToTaskDetail(taskItem.id!); $event.stopPropagation()"
                     (keydown.space)="navigateToTaskDetail(taskItem.id!); $event.stopPropagation()"
                     tabindex="0"
                     role="link"
                     [attr.aria-label]="'タスク「' + taskItem.title + '」の詳細を開く'">
                     {{ taskItem.title }}
                </div>
                <div class="task-list-cell" style="width: 100px;">-</div>
                <div class="task-list-cell" style="width: 80px;">-</div>
                <div class="task-list-cell" style="width: 70px;">-</div>
                <div class="task-list-cell" style="width: 100px;">
                   {{ taskItem.plannedStartDate.toDate() | date:'yyyy/MM/dd' }}
                </div>
                <div class="task-list-cell" style="width: 100px;">
                    {{ taskItem.plannedEndDate.toDate() | date:'yyyy/MM/dd' }}
                </div>
                <div class="task-list-cell" style="width: 100px;">-</div>
                <div class="task-list-cell" style="width: 100px;">-</div>
                <div class="task-list-cell task-actions" style="width: 100px;">
                    <button mat-icon-button color="primary" (click)="openEditTaskDialog(taskItem); $event.stopPropagation()" aria-label="タスクを編集">
                        <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-icon-button color="warn" (click)="confirmDeleteNewSimpleTask(taskItem); $event.stopPropagation()" aria-label="タスクを削除">
                        <mat-icon>delete</mat-icon>
                    </button>
                </div>
            </div>
        </div>

        <div class="gantt-bars-area">
            <div class="gantt-row-background">
                <div *ngFor="let day of allDaysInTimeline" class="gantt-day-cell"></div>
            </div>
            <div *ngFor="let taskItem of ganttTasks"
                 class="gantt-row"
                 [ngClass]="{'selected-task-bar-indicator': taskItem.id === selectedTask?.id}">

                <div class="gantt-bar"
                     [style.left.px]="getBarLeftPosition(taskItem.plannedStartDate.toDate())"
                     [style.width.px]="getBarWidth(taskItem.plannedStartDate.toDate(), taskItem.plannedEndDate.toDate())"
                     [title]="taskItem.title + ' (予定: ' + (taskItem.plannedStartDate.toDate() | date:'MM/dd') + '-' + (taskItem.plannedEndDate.toDate() | date:'MM/dd') + ')'">
                     {{ taskItem.title }}
                </div>

                <div *ngIf="taskItem.actualStartDate"
                     class="gantt-bar actual-bar" [style.left.px]="getBarLeftPosition(taskItem.actualStartDate.toDate())"
                     [style.width.px]="getBarWidth(taskItem.actualStartDate.toDate(), (taskItem.actualEndDate ? taskItem.actualEndDate.toDate() : getToday()))"
                     [title]="taskItem.title + ' (実績: ' + (taskItem.actualStartDate.toDate() | date:'MM/dd') + '-' + (taskItem.actualEndDate ? (taskItem.actualEndDate.toDate() | date:'MM/dd') : '継続中') + ')'">
                     <!-- 実績バーは内容表示なし -->
                </div>
                </div>
        </div>

        <div *ngIf="isLoadingProject; else projectContentLoaded">
            <p>プロジェクト情報を読み込んでいます...</p>
          </div>
          <ng-template #projectContentLoaded>
            <div *ngIf="projectError" class="error-message">
              <p>{{ projectError }}</p>
            </div>
          
            <div *ngIf="project$ | async as project"> <h2 *ngIf="project">{{ project.name }} - ガントチャート</h2>
              <h2 *ngIf="!project && projectId">プロジェクト (ID: {{ projectId }}) - ガントチャート</h2>
          
              <div *ngIf="isLoadingTasks; else tasksContentLoaded">
                <p>タスクを読み込んでいます...</p>
              </div>
              <ng-template #tasksContentLoaded>
                <div *ngIf="tasksError" class="error-message">
                  <p>{{ tasksError }}</p>
                </div>
          
                <div *ngIf="tasks$ | async as tasks"> <div *ngIf="tasks.length > 0; else noTasks">
                    <p>ガントチャート表示エリア (タスク数: {{ tasks.length }})</p>
                    <ul class="task-list">
                      <li *ngFor="let task of tasks" class="task-item">
                        <strong>{{ task.title }}</strong>
                        <span *ngIf="task.plannedStartDate && task.plannedEndDate">
                          ({{ task.plannedStartDate.toDate() | date:'yyyy/MM/dd' }} - {{ task.plannedEndDate.toDate() | date:'yyyy/MM/dd' }})
                        </span>
                        <!-- <p *ngIf="task.description">{{ task.description }}</p> -->
                        <p>ステータス: - | 進捗: -</p>
                      </li>
                    </ul>
                  </div>
                  <ng-template #noTasks><p>このプロジェクトには表示できるタスクがありません。</p></ng-template>
                </div>
              </ng-template>
            </div>
          </ng-template>
    </div>