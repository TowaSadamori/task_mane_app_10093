<div class="dashboard-container">
  <h2 class="dashboard-title">HOME</h2>
  <div class="dashboard-header">
    <div style="margin-left: auto;">
      <button class="create-project-button" (click)="openCreateProjectDialog()" matTooltip="新しいプロジェクトを作成します。">
        新しいプロジェクトを作成
      </button>
    </div>
  </div>
  <div *ngIf="projects$ | async as projects; else loadingOrError">
    <div class="project-list" *ngIf="projects.length > 0; else noProjects">
      <div *ngFor="let project of projects" class="project-item">
        <div class="project-info">
          <a [routerLink]="['/app/gantt-chart', project.id]" matTooltip="クリックしてタスク一覧へ">
            {{ project.name }}
          </a>
          <div class="project-period" *ngIf="project.startDate || project.endDate">
            <ng-container *ngIf="project.startDate && project.endDate">
              期間: {{ toDateSafe(project.startDate) | date:'yyyy/MM/dd' }} 〜 {{ toDateSafe(project.endDate) | date:'yyyy/MM/dd' }}
            </ng-container>
            <ng-container *ngIf="project.startDate && !project.endDate">
              開始日: {{ toDateSafe(project.startDate) | date:'yyyy/MM/dd' }}
            </ng-container>
            <ng-container *ngIf="!project.startDate && project.endDate">
              終了日: {{ toDateSafe(project.endDate) | date:'yyyy/MM/dd' }}
            </ng-container>
          </div>
          <div class="project-users">
            <div><span class="desc-label">管理者：</span>
              <span>{{ getUserNamesByIds(project.managerIds ?? (project.managerId ? [project.managerId] : [])).join(', ') }}</span>
            </div>
            <div *ngIf="project.members && project.members.length > 0"><span class="desc-label">担当者：</span>
              <span>{{ getUserNamesByIds(project.members).join(', ') }}</span>
            </div>
          </div>
          <div class="project-description">
            <div class="desc-label">説明：</div>
            <div class="desc-content">{{ project.description }}</div>
          </div>
          <div class="progress-circle-large" style="display: flex; justify-content: center; width: 100%; margin: 16px 0;">
            <svg width="160" height="160">
              <circle cx="80" cy="80" r="64" stroke="#eee" stroke-width="24" fill="none"/>
              <circle
                cx="80" cy="80" r="64"
                stroke="#1976d2"
                stroke-width="24"
                fill="none"
                [attr.stroke-dasharray]="2 * 3.1416 * 64"
                [attr.stroke-dashoffset]="2 * 3.1416 * 64 - (2 * 3.1416 * 64 * getProjectProgress(project.id) / 100)"
                stroke-linecap="round"
                style="transition: stroke-dashoffset 0.5s;"
              />
              <text x="80" y="100" text-anchor="middle" font-size="40" fill="#1976d2" font-weight="bold">
                {{ getProjectProgress(project.id) }}%
              </text>
            </svg>
          </div>
        </div>
        <div class="project-actions">
          <button mat-icon-button color="primary" aria-label="プロジェクトを編集" (click)="openEditProjectDialog(project)" matTooltip="編集します。">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button color="warn" aria-label="プロジェクトを削除" (click)="confirmDeleteProject(project)" matTooltip="削除します。">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>
    </div>
    <ng-template #noProjects>
      <p>現在進行中のプロジェクトはありません。</p>
    </ng-template>
  </div>
  <ng-template #loadingOrError>
    <p>プロジェクトを読み込んでいます...</p>
  </ng-template>
</div>
